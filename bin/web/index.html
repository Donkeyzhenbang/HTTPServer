<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>è¾“ç”µå…¨æ™¯ç®¡æ§å¹³å°</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #031416;
      --panel: rgba(3,37,38,0.6);
      --accent: #06b3b0;
      --accent-2: #07d4d0;
      --muted: #bfeee9;
      --card-radius: 10px;
      --topbar-h: 64px;
      --gap: 12px;
      --thumb-group-size: 5;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0;font-family:"Inter", Arial, sans-serif;-webkit-font-smoothing:antialiased}
    body{
      background:
        radial-gradient(900px 240px at 10% 8%, rgba(6,179,176,0.03), transparent 9%),
        linear-gradient(180deg, rgba(0,8,10,0.62), rgba(0,6,8,0.96)),
        var(--bg);
      color:var(--muted);
      overflow:hidden;
    }

    /* topbar */
    .topbar{
      height: var(--topbar-h);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 0 20px;
      border-bottom: 1px solid rgba(6,179,176,0.06);
      background: linear-gradient(180deg, rgba(2,18,20,0.5), rgba(2,12,14,0.2));
      box-shadow: 0 6px 20px rgba(0,0,0,0.6);
      z-index:50;
    }
    .brand{display:flex;align-items:center;gap:14px}
    .logo{width:46px;height:46px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:#021212;font-weight:800;box-shadow:0 8px 26px rgba(6,179,176,0.08)}
    .title{font-size:18px;color:var(--accent);font-weight:700}
    .subtitle{font-size:12px;color:rgba(191,238,233,0.7)}

    .nav-tabs{display:flex;gap:8px}
    .nav-tabs button{background:transparent;border:0;color:var(--muted);padding:8px 14px;border-radius:8px;cursor:pointer;font-weight:600;transition:all .15s}
    .nav-tabs button.active{background:linear-gradient(90deg, rgba(6,179,176,0.12), rgba(6,179,176,0.06));color:var(--accent);box-shadow:0 6px 18px rgba(6,179,176,0.06)}

    /* layout fills remaining height */
    .main {
      display:grid;
      grid-template-columns: 320px 1fr 300px;
      grid-template-rows: calc(100vh - var(--topbar-h));
      gap: var(--gap);
      padding: 12px;
      height: calc(100vh - var(--topbar-h));
    }

    .panel {
      background: linear-gradient(180deg, rgba(3,28,29,0.46), rgba(2,18,20,0.28));
      border-radius: var(--card-radius);
      padding: 14px;
      border:1px solid rgba(6,179,176,0.06);
      box-shadow: 0 18px 60px rgba(0,0,0,0.6);
      overflow: hidden;
    }

    /* left */
    .left-panel{ display:flex; flex-direction:column; gap:12px; min-height:0; }
    .left-panel h3{margin:0;color:var(--accent);font-weight:700}
    .upload-box{background:rgba(0,0,0,0.06);padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}
    input[type=file]{width:100%;padding:8px;border-radius:6px;background: rgba(255,255,255,0.02);color:var(--muted);border:none;outline:none;cursor:pointer}
    .device-list{overflow:auto;padding-right:6px}
    .device{display:flex;justify-content:space-between;align-items:flex-start;padding:10px;border-radius:8px;margin-bottom:10px;background:linear-gradient(180deg, rgba(0,0,0,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02)}
    .device strong{color:#fff}
    .device .meta{font-size:12px;color:#7ab7b5;margin-top:6px}

    /* center */
    .center{ display:flex; flex-direction:column; gap:12px; min-height:0; }
    .viewer-wrap{
      flex:1 1 auto;
      border-radius:10px;
      position:relative;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      background: linear-gradient(180deg, rgba(0,0,0,0.12), rgba(0,0,0,0.06));
      border:1px solid rgba(6,179,176,0.06);
    }
    .viewer-inner{ width:100%; height:100%; display:flex; align-items:center; justify-content:center; position:relative; touch-action:none; background: linear-gradient(180deg, rgba(2,10,10,0.05), transparent); }
    .viewer-inner img{ max-width:100%; max-height:100%; transition:transform .16s ease; user-select:none; -webkit-user-drag:none; will-change:transform; border-radius:6px; box-shadow: 0 14px 48px rgba(0,0,0,0.6) }

    .viewer-overlay{ position:absolute; left:16px; top:14px; z-index:40; background:rgba(0,0,0,0.24); padding:6px 10px;border-radius:6px;color:#fff;font-size:12px;border:1px solid rgba(255,255,255,0.03);backdrop-filter: blur(6px) }
    .viewer-watermark{ position:absolute; right:16px; bottom:14px; z-index:40; font-size:12px; color:rgba(255,255,255,0.5); background: linear-gradient(90deg, rgba(0,0,0,0.12), rgba(0,0,0,0.06)); padding:4px 8px; border-radius:6px }

    .arrow{ position:absolute; top:50%; transform:translateY(-50%); z-index:50; width:46px; height:46px; border-radius:50%; display:flex; align-items:center; justify-content:center; background: rgba(0,0,0,0.28); border:1px solid rgba(255,255,255,0.03); cursor:pointer; color:var(--muted); font-weight:700; transition: transform .12s, background .12s }
    .arrow:hover{ transform:translateY(-50%) scale(1.06); background: rgba(6,179,176,0.08); color:var(--accent) }
    .arrow.left{ left: 14px } .arrow.right{ right:14px }

    /* thumbnail strip: will render groups of 5 */
    .thumb-strip{ height:106px; display:flex; gap:10px; align-items:center; padding:8px; overflow:hidden; background: linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.01)); border-radius:8px; position:relative}
    .thumb-window{ display:flex; gap:10px; transition: transform .28s cubic-bezier(.2,.9,.2,1); will-change:transform; }
    .thumb-item{ width:160px; height:90px; flex: 0 0 160px; border-radius:8px; overflow:hidden; position:relative; border:1px solid rgba(255,255,255,0.02); cursor:pointer; transition: transform .12s, box-shadow .12s }
    .thumb-item img{ width:100%; height:100%; object-fit:cover; display:block }
    .thumb-item.active{ border:2px solid var(--accent); transform: translateY(-6px); box-shadow: 0 18px 48px rgba(6,179,176,0.08) }
    .thumb-caption{ position:absolute; left:8px; bottom:8px; font-size:11px; color:#fff; background:rgba(0,0,0,0.32); padding:4px 6px; border-radius:4px }

    /* group nav small arrows on sides of strip */
    .strip-arrow{ position:absolute; top:50%; transform:translateY(-50%); width:34px;height:34px;border-radius:6px;background:rgba(0,0,0,0.18);display:flex;align-items:center;justify-content:center;color:var(--muted);cursor:pointer;border:1px solid rgba(255,255,255,0.02); }
    .strip-arrow:hover{ background:rgba(6,179,176,0.06); color:var(--accent) }
    .strip-arrow.left{ left:6px } .strip-arrow.right{ right:6px }

    /* right panel */
    .right-panel{ display:flex; flex-direction:column; gap:12px; min-height:0; }
    .card-title{ color:var(--accent); font-weight:700; margin-bottom:6px }
    .date-picker input{ width:100%; padding:10px; border-radius:8px; background: rgba(0,0,0,0.06); border:1px solid rgba(255,255,255,0.02); color:var(--muted) }
    .ops{ display:flex; gap:8px; flex-wrap:wrap }
    .ops button{ flex:1 1 48%; padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02); background:transparent; color:var(--muted); cursor:pointer; font-weight:700 }
    .ops button.primary{ background: linear-gradient(90deg,var(--accent),var(--accent-2)); color:#021212; box-shadow:0 8px 26px rgba(6,179,176,0.08) }

    .channels{ display:flex; gap:8px; }
    .channel-btn{ flex:1; padding:10px;border-radius:8px;background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.02); cursor:pointer; color:var(--muted); font-weight:700 }
    .channel-btn.active{ background: linear-gradient(90deg,var(--accent),var(--accent-2)); color:#021212 }

    @media (max-width:1100px){
      .main{ grid-template-columns: 300px 1fr; grid-template-rows: calc(100vh - var(--topbar-h) - 320px) 320px; }
      .right-panel{ grid-column: 1 / -1; grid-row: 2 / 3; }
    }
    @media (max-width:820px){
      .topbar{ padding:10px; flex-wrap:wrap; height:auto; gap:8px; align-items:flex-start }
      .main{ grid-template-columns: 1fr; grid-template-rows: auto 340px auto; gap:10px }
      .left-panel{ order:3 }
      .center{ order:1 }
      .right-panel{ order:2 }
      .thumb-strip{ height:90px }
      .viewer-wrap{ height:420px }
    }

    ::-webkit-scrollbar{ height:10px; width:10px }
    ::-webkit-scrollbar-thumb{ background: rgba(6,179,176,0.12); border-radius:6px }
    ::-webkit-scrollbar-track{ background: transparent }
  </style>
</head>
<body>
  <div class="topbar" role="navigation" aria-label="ä¸»å¯¼èˆª">
    <div class="brand">
      <div class="logo" aria-hidden="true">è¾“</div>
      <div>
        <div class="title">è¾“ç”µå…¨æ™¯ç®¡æ§å¹³å°</div>
        <div class="subtitle">åœ¨çº¿ç›‘æ§ Â· å…¨æ™¯è¦å›¾ Â· è®¾å¤‡ç®¡ç†</div>
      </div>
    </div>

    <div class="nav-tabs" role="tablist" aria-label="ä¸»åŠŸèƒ½å¯¼èˆª">
      <button class="active" data-tab="dashboard" role="tab">å¯è§†åŒ–çœ‹æ¿</button>
      <button data-tab="resources" role="tab">èµ„æºç®¡ç†</button>
      <button data-tab="stats" role="tab">æŸ¥è¯¢ç»Ÿè®¡</button>
      <button data-tab="vendors" role="tab">å‚å•†ç®¡ç†</button>
    </div>

    <div style="display:flex;align-items:center;gap:8px">
      <button id="refreshAll" class="nav-action" title="åˆ·æ–°å…¨éƒ¨" style="background:transparent;border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:8px;color:var(--muted);cursor:pointer">åˆ·æ–°</button>
    </div>
  </div>

  <div class="main">
    <!-- left -->
    <aside class="panel left-panel" aria-label="è®¾å¤‡ä¸ä¸Šä¼ ">
      <h3>è®¾å¤‡ç®¡ç†</h3>

      <div class="upload-box" aria-label="å›¾ç‰‡ä¸Šä¼ ">
        <form id="uploadForm">
          <input id="fileInput" type="file" name="image" accept="image/*" aria-label="ä¸Šä¼ å›¾ç‰‡" />
          <div style="height:8px"></div>
          <button type="submit" class="btn small" style="width:100%; background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#021212; border:none; padding:10px; border-radius:8px; font-weight:700;">ä¸Šä¼ å›¾ç‰‡</button>
        </form>
        <div id="uploadResult" style="margin-top:8px;font-size:13px;color:var(--muted)"></div>
      </div>

      <div id="devicesContainer" class="device-list" aria-live="polite">
        <div class="device">
          <div style="width:100%;text-align:center;color:var(--muted)">æ­£åœ¨åŠ è½½è®¾å¤‡åˆ—è¡¨...</div>
        </div>
      </div>
    </aside>

    <!-- center -->
    <main class="panel center" aria-label="ä¸»è§†å›¾">
      <div class="viewer-wrap" id="viewerWrap" role="region" aria-label="å›¾åƒå±•ç¤ºåŒº">
        <div class="viewer-overlay" id="viewerOverlay">-- æ—¶é—´æˆ³ --</div>
        <div class="viewer-inner" id="viewerInner" aria-live="polite" aria-label="å¤§å›¾å±•ç¤º">
          <div style="color:var(--muted)">å¤§å›¾åŠ è½½ä¸­...</div>
        </div>
        <div class="viewer-watermark">ç¤ºä¾‹æ°´å°</div>

        <div class="arrow left" id="prevBtn" aria-label="ä¸Šä¸€å¼ ">â€¹</div>
        <div class="arrow right" id="nextBtn" aria-label="ä¸‹ä¸€å¼ ">â€º</div>
      </div>

      <div class="thumb-strip" id="thumbStrip" aria-label="ç¼©ç•¥å›¾æ—¶é—´è½´">
        <div class="strip-arrow left" id="stripPrev" aria-hidden="true">â—‚</div>
        <div style="overflow:hidden; flex:1;">
          <div class="thumb-window" id="thumbWindow" aria-hidden="false"></div>
        </div>
        <div class="strip-arrow right" id="stripNext" aria-hidden="true">â–¸</div>
      </div>
    </main>

    <!-- right -->
    <aside class="panel right-panel" aria-label="æ“ä½œé¢æ¿">
      <div>
        <div class="card-title">æ—¥æœŸé€‰æ‹©</div>
        <div class="date-picker"><input id="datePicker" type="date" aria-label="é€‰æ‹©æ—¥æœŸ" /></div>
      </div>

      <div>
        <div class="card-title">æ“ä½œé¡¹</div>
        <div class="ops" role="group" aria-label="æ“ä½œ">
          <button id="grabBtn" class="primary" style="padding:10px 12px;">æŠ“å›¾</button>
          <button id="playbackBtn">å›æ”¾</button>
          <button id="downloadBtn">ä¸‹è½½</button>
          <button id="fullBtn">å…¨å±</button>
        </div>
      </div>

      <div>
        <div class="card-title">ç›‘æ‹é€šé“</div>
        <div class="channels" role="tablist" aria-label="é€šé“é€‰æ‹©">
          <button class="channel-btn active" data-channel="1">é€šé“ 1</button>
          <button class="channel-btn" data-channel="2">é€šé“ 2</button>
          <button class="channel-btn" data-channel="3">é€šé“ 3</button>
          <button class="channel-btn" data-channel="4">é€šé“ 4</button>
        </div>
      </div>

      <div style="margin-top:auto;font-size:12px;color:#7ab7b5">
        å¿«æ·æç¤ºï¼šç¼©ç•¥å›¾ç‚¹å‡»åˆ‡æ¢ä¸»å›¾ï¼›åŒå‡»ä¸»å›¾é‡ç½®ç¼©æ”¾ï¼›æ»šè½®ç¼©æ”¾ï¼›æ”¾å¤§æ—¶å¯æ‹–åŠ¨å¹³ç§»ã€‚
      </div>
    </aside>
  </div>

  <script>
    /************************************************************************
     * è¦ç‚¹ï¼š
     * - ç¼©ç•¥å›¾æŒ‰ç»„æ˜¾ç¤ºï¼šæ¯ç»„ 5 å¼ ï¼ˆå¯é€šè¿‡ --thumb-group-size ä¿®æ”¹ï¼‰ã€‚
     * - å½“ä¸»å›¾ç´¢å¼•è·³è½¬åˆ°ä¸åœ¨å½“å‰ç¼©ç•¥å›¾ç»„ï¼ˆå‘å·¦æˆ–å‘å³ï¼‰æ—¶ï¼Œä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°åŒ…å«è¯¥å›¾ç‰‡çš„ç»„ã€‚
     * - ä¸ä¿®æ”¹åç«¯æ¥å£æˆ–åç«¯é€»è¾‘ï¼ˆä¿ç•™ /api/... ä¸ /uploads/... çš„è°ƒç”¨ï¼‰ã€‚
     ************************************************************************/

    let imagesList = [];
    let currentIndex = -1;
    let scale = 1;
    let translate = {x:0,y:0};
    let isPanning = false;
    let panStart = {x:0,y:0};
    let refreshInterval;

    // ç¼©ç•¥å›¾ç»„ç®¡ç†
    const THUMB_GROUP_SIZE = 5;
    let thumbGroupStart = 0; // å½“å‰ç»„èµ·å§‹ç´¢å¼•ï¼ˆåœ¨ imagesList ä¸­ï¼‰

    async function fetchJSON(url, opts = {}) {
      const r = await fetch(url, opts);
      return r.json();
    }

    /* è®¾å¤‡ */
    // async function loadDevices() {
    //   try {
    //     const data = await fetchJSON('/api/devices');
    //     const c = document.getElementById('devicesContainer');
    //     c.innerHTML = '';

    //     if (!data.devices || data.devices.length === 0) {
    //       const emptyMsg = document.createElement('div');
    //       emptyMsg.className = 'device';
    //       emptyMsg.innerHTML = `
    //         <div style="text-align:center;width:100%;color:var(--muted)">
    //           <div>å½“å‰æ— å·²æ³¨å†Œè®¾å¤‡</div>
    //           <div style="font-size:12px;color:#7ab7b5;margin-top:6px">æ€»è¿æ¥æ•°: ${data.connections||0}</div>
    //         </div>
    //       `;
    //       c.appendChild(emptyMsg);
    //       return;
    //     }

    //     data.devices.forEach(dev => {
    //       const div = document.createElement('div');
    //       div.className = 'device';
    //       div.innerHTML = `
    //         <div>
    //           <strong>${dev}</strong>
    //           <div class="meta">è®¾å¤‡ID: ${dev}</div>
    //         </div>
    //         <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
    //           <span style="background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#021212;padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px">å·²æ³¨å†Œ</span>
    //           <button class="btn small" style="margin-top:6px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#021212;border:none;padding:6px 10px;border-radius:6px;">ğŸ“· è¦å›¾</button>
    //         </div>
    //       `;
    //       const btn = div.querySelector('button');
    //       btn.onclick = async () => {
    //         btn.disabled = true;
    //         const old = btn.innerHTML;
    //         btn.innerText = 'å‘é€ä¸­â€¦';
    //         try {
    //           const resp = await fetch('/api/request_snapshot', {
    //             method:'POST',
    //             headers:{'Content-Type':'application/json'},
    //             body: JSON.stringify({ device: dev, channel: 1 })
    //           });
    //           const j = await resp.json();
    //           if (j.ok) showNotification(`å·²å‘è®¾å¤‡ ${dev} å‘é€è¦å›¾æŒ‡ä»¤`, 'success'); else showNotification(`å‘é€å¤±è´¥: ${j.error || 'æœªçŸ¥'}`, 'error');
    //         } catch(e) {
    //           showNotification('è¯·æ±‚å¤±è´¥: '+ e.message,'error');
    //         } finally {
    //           btn.disabled = false;
    //           btn.innerHTML = old;
    //         }
    //       };
    //       c.appendChild(div);
    //     });

    //   } catch (e) {
    //     console.error('åŠ è½½è®¾å¤‡å¤±è´¥', e);
    //     const c = document.getElementById('devicesContainer');
    //     c.innerHTML = '<div class="device" style="color:#ff6b6b">åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨</div>';
    //   }
    // }

    /* å›¾ç‰‡åŠ è½½ä¸åˆ†ç»„æœºåˆ¶ */
    // async function loadImages() {
    //   try {
    //     const arr = await fetchJSON('/api/images');
    //     imagesList = Array.isArray(arr) ? arr : [];
    //     // é€‰ä¸­æœ€åä¸€å¼ ï¼ˆå¦‚æœæœ‰ï¼‰
    //     if (imagesList.length > 0) {
    //       setCurrentIndex(imagesList.length - 1, {autoAdjustGroup:true});
    //     } else {
    //       renderViewerEmpty();
    //       renderThumbGroup();
    //     }
    //   } catch (e) {
    //     console.error('åŠ è½½å›¾ç‰‡å¤±è´¥', e);
    //     renderViewerEmpty();
    //     renderThumbGroup();
    //   }
    // }
    /* å›¾ç‰‡åŠ è½½ä¸åˆ†ç»„æœºåˆ¶ */
    async function loadImages() {
      try {
        // æ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜ï¼Œå¼ºåˆ¶åˆ·æ–°
        const arr = await fetchJSON('/api/images?_=' + Date.now());
        imagesList = Array.isArray(arr) ? arr : [];
        
        // å¦‚æœæœ‰æ–°å›¾ç‰‡ï¼Œé€‰æ‹©æœ€åä¸€å¼ 
        if (imagesList.length > 0) {
          setCurrentIndex(imagesList.length - 1, {autoAdjustGroup:true});
          // åŒæ—¶åˆ·æ–°ç¼©ç•¥å›¾
          renderThumbGroup();
        } else {
          renderViewerEmpty();
          renderThumbGroup();
        }
      } catch (e) {
        console.error('åŠ è½½å›¾ç‰‡å¤±è´¥', e);
        renderViewerEmpty();
        renderThumbGroup();
      }
    }

    /* åˆ·æ–°æŒ‰é’®åŠŸèƒ½å¢å¼º */
    document.getElementById('refreshAll').addEventListener('click', async () => {
      try {
        // æ¸…é™¤å¯èƒ½çš„ç¼“å­˜
        imagesList = [];
        currentIndex = -1;
        thumbGroupStart = 0;
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const viewerInner = document.getElementById('viewerInner');
        viewerInner.innerHTML = '<div style="color:var(--muted)">åˆ·æ–°ä¸­...</div>';
        
        // å¹¶è¡Œåˆ·æ–°è®¾å¤‡å’Œå›¾ç‰‡
        await Promise.all([
          loadDevices(),
          loadImages()
        ]);
        showNotification('å·²åˆ·æ–°å›¾ç‰‡å’Œè®¾å¤‡åˆ—è¡¨', 'success');
      } catch (e) {
        console.error('åˆ·æ–°å¤±è´¥', e);
        showNotification('åˆ·æ–°å¤±è´¥: ' + e.message, 'error');
      }
    });

    /* ä¿®æ”¹ç¼©ç•¥å›¾ç‚¹å‡»äº‹ä»¶ï¼Œå¼ºåˆ¶åˆ·æ–°å›¾ç‰‡ */
    function attachThumbClickEvents() {
      const windowEl = document.getElementById('thumbWindow');
      const items = Array.from(windowEl.querySelectorAll('.thumb-item'));
      
      items.forEach(item => {
        // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
        item.onclick = null;
        
        // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
        item.onclick = () => {
          const globalIdx = parseInt(item.dataset.index);
          // é‡æ–°åŠ è½½å›¾ç‰‡ï¼Œé¿å…ç¼“å­˜
          const img = item.querySelector('img');
          if (img) {
            img.src = '/uploads/' + encodeURIComponent(item.dataset.name) + '?_=' + Date.now();
          }
          setCurrentIndex(globalIdx, {autoAdjustGroup:true, smoothScroll:true});
        };
      });
    }

    // ä¿®æ”¹renderThumbGroupå‡½æ•°ï¼Œè°ƒç”¨attachThumbClickEvents
    function renderThumbGroup(){
      const windowEl = document.getElementById('thumbWindow');
      windowEl.innerHTML = '';
      if (!imagesList || imagesList.length === 0) return;
      
      if (thumbGroupStart < 0) thumbGroupStart = 0;
      if (thumbGroupStart > Math.max(0, imagesList.length - 1)) thumbGroupStart = Math.max(0, imagesList.length - 1);
      
      const group = imagesList.slice(thumbGroupStart, thumbGroupStart + THUMB_GROUP_SIZE);
      group.forEach((name, localIdx) => {
        const globalIdx = thumbGroupStart + localIdx;
        const item = document.createElement('div');
        item.className = 'thumb-item';
        item.dataset.name = name;
        item.dataset.index = globalIdx;
        
        const img = document.createElement('img');
        // æ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜
        img.src = '/uploads/' + encodeURIComponent(name) + '?_=' + Date.now();
        img.alt = name;
        item.appendChild(img);
        
        const cap = document.createElement('div');
        cap.className = 'thumb-caption';
        cap.innerText = name.length > 18 ? name.slice(0,18) + 'â€¦' : name;
        item.appendChild(cap);

        windowEl.appendChild(item);
      });
      
      // æ›´æ–°äº‹ä»¶ç›‘å¬å™¨
      attachThumbClickEvents();
      updateThumbActiveState();
      updateStripArrowState();
      updateThumbWindowTransform();
    }

    // ä¿®æ”¹renderMainImageå‡½æ•°ï¼Œæ·»åŠ æ—¶é—´æˆ³
    function renderMainImage(name){
      const inner = document.getElementById('viewerInner');
      inner.innerHTML = '';
      scale = 1; translate = {x:0,y:0};
      const img = document.createElement('img');
      // æ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜
      img.src = '/uploads/' + encodeURIComponent(name) + '?_=' + Date.now();
      img.alt = name;
      img.draggable = false;
      
      // æ·»åŠ å›¾ç‰‡åŠ è½½å¤±è´¥å¤„ç†
      img.onerror = function() {
        console.log('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œé‡è¯•...');
        // 1ç§’åé‡è¯•
        setTimeout(() => {
          this.src = '/uploads/' + encodeURIComponent(name) + '?_=' + Date.now();
        }, 1000);
      };
      
      img.onload = function() {
        console.log('å›¾ç‰‡åŠ è½½æˆåŠŸ:', name);
        // å›¾ç‰‡åŠ è½½æˆåŠŸåçš„å¤„ç†
      };
      
      inner.appendChild(img);
      document.getElementById('viewerOverlay').innerText = name;
      setupImageInteractions(inner, img);
      updateThumbActiveState();
    }

    // ä¿®æ”¹ä¸Šä¼ æˆåŠŸçš„å›è°ƒ
    document.getElementById('uploadForm').addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const f = document.getElementById('fileInput').files[0];
      if (!f) { showNotification('è¯·é€‰æ‹©æ–‡ä»¶', 'error'); return; }
      const fd = new FormData();
      fd.append('image', f, f.name);
      const resDiv = document.getElementById('uploadResult');
      resDiv.innerText = 'ä¸Šä¼ ä¸­...';
      try {
        const resp = await fetch('/upload', { method:'POST', body: fd });
        const j = await resp.json();
        if (j.ok) {
          resDiv.innerText = 'ä¸Šä¼ æˆåŠŸ: ' + j.filename;
          showNotification('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success');
          // æ¸…ç©ºæ–‡ä»¶è¾“å…¥æ¡†
          document.getElementById('fileInput').value = '';
          
          // ç­‰å¾…ä¸€å°æ®µæ—¶é—´è®©åç«¯ä¿å­˜å®Œæˆ
          setTimeout(async () => {
            await loadImages();
            showNotification('å›¾ç‰‡å·²æ·»åŠ åˆ°åˆ—è¡¨ä¸­', 'success');
          }, 500);
        } else {
          resDiv.innerText = 'ä¸Šä¼ å¤±è´¥: ' + (j.error||'æœªçŸ¥');
          showNotification('ä¸Šä¼ å¤±è´¥: ' + (j.error||'æœªçŸ¥'), 'error');
        }
      } catch (e) {
        resDiv.innerText = 'ä¸Šä¼ å¼‚å¸¸: ' + e.message;
        showNotification('ä¸Šä¼ å¼‚å¸¸: ' + e.message, 'error');
      }
    });

    /* æ–°å¢ï¼šå®šæ—¶åˆ·æ–°å›¾ç‰‡åˆ—è¡¨ï¼ˆå¯é€‰ï¼‰ */
    function startAutoRefresh() {
      // æ¯10ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡å›¾ç‰‡åˆ—è¡¨
      setInterval(async () => {
        if (document.visibilityState === 'visible') {
          try {
            await loadImages();
          } catch (e) {
            console.log('è‡ªåŠ¨åˆ·æ–°å¤±è´¥:', e);
          }
        }
      }, 10000); // 10ç§’
    }

    // åœ¨initå‡½æ•°ä¸­å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
    async function init() {
      try {
        await loadConnectionStats();
        await loadDevices();
        await loadImages();
        // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
        startAutoRefresh();
        // åŸæ¥çš„åˆ·æ–°é—´éš”åªåˆ·æ–°è®¾å¤‡åˆ—è¡¨
        refreshInterval = setInterval(async () => { 
          await loadDevices(); 
          await loadConnectionStats(); 
        }, 5000);
      } catch (e) {
        console.error('åˆå§‹åŒ–å¼‚å¸¸', e);
      }
    }

    function renderViewerEmpty(){
      const inner = document.getElementById('viewerInner');
      inner.innerHTML = '<div style="color:var(--muted)">æš‚æ— å›¾ç‰‡ï¼Œè¯·ä¸Šä¼ æˆ–è¯·æ±‚è¦å›¾</div>';
      document.getElementById('viewerOverlay').innerText = '-- æ—¶é—´æˆ³ --';
    }

    // è®¡ç®—å¹¶æ¸²æŸ“å½“å‰ç¼©ç•¥å›¾ç»„ï¼ˆä» thumbGroupStart å¼€å§‹ï¼Œå– THUMB_GROUP_SIZE å¼ ï¼‰
    // function renderThumbGroup(){
    //   const windowEl = document.getElementById('thumbWindow');
    //   windowEl.innerHTML = '';
    //   if (!imagesList || imagesList.length === 0) return;
    //   // æ ¡å‡† thumbGroupStart
    //   if (thumbGroupStart < 0) thumbGroupStart = 0;
    //   if (thumbGroupStart > Math.max(0, imagesList.length - 1)) thumbGroupStart = Math.max(0, imagesList.length - 1);
    //   const group = imagesList.slice(thumbGroupStart, thumbGroupStart + THUMB_GROUP_SIZE);
    //   group.forEach((name, localIdx) => {
    //     const globalIdx = thumbGroupStart + localIdx;
    //     const item = document.createElement('div');
    //     item.className = 'thumb-item';
    //     item.dataset.name = name;
    //     item.dataset.index = globalIdx;
    //     const img = document.createElement('img');
    //     img.src = '/uploads/' + encodeURIComponent(name) + '?t=' + Date.now();
    //     img.alt = name;
    //     item.appendChild(img);
    //     const cap = document.createElement('div');
    //     cap.className = 'thumb-caption';
    //     cap.innerText = name.length>18 ? name.slice(0,18)+'â€¦' : name;
    //     item.appendChild(cap);

    //     item.onclick = () => {
    //       // ç›´æ¥è®¾ç½®å…¨å±€ç´¢å¼•
    //       setCurrentIndex(globalIdx, {autoAdjustGroup:true, smoothScroll:true});
    //     };

    //     windowEl.appendChild(item);
    //   });
    //   updateThumbActiveState();
    //   updateStripArrowState();
    //   // è®¾ç½® thumbWindow transformï¼ˆresetï¼‰
    //   updateThumbWindowTransform();
    // }

    function updateThumbWindowTransform(){
      // We show the group (thumbGroupStart) as the visible group, so thumbWindow transform = 0
      // but keep for potential animation: set transform to 0
      const windowEl = document.getElementById('thumbWindow');
      windowEl.style.transform = `translateX(0px)`;
    }

    function updateThumbActiveState(){
      const windowEl = document.getElementById('thumbWindow');
      const items = Array.from(windowEl.querySelectorAll('.thumb-item'));
      items.forEach(it => it.classList.remove('active'));
      if (currentIndex >= 0) {
        const active = items.find(it => Number(it.dataset.index) === currentIndex);
        if (active) active.classList.add('active');
      }
    }

    function updateStripArrowState(){
      // å·¦ç®­å¤´å¯ç”¨å½“ thumbGroupStart > 0
      const left = document.getElementById('stripPrev');
      const right = document.getElementById('stripNext');
      left.style.opacity = thumbGroupStart > 0 ? '1' : '0.28';
      right.style.opacity = (thumbGroupStart + THUMB_GROUP_SIZE) < imagesList.length ? '1' : '0.28';
      left.style.pointerEvents = thumbGroupStart > 0 ? 'auto' : 'none';
      right.style.pointerEvents = (thumbGroupStart + THUMB_GROUP_SIZE) < imagesList.length ? 'auto' : 'none';
    }

    // å°† globalIndex è®¾ç½®ä¸ºå½“å‰å›¾ï¼Œå¹¶å¯é€‰æ˜¯å¦è‡ªåŠ¨è°ƒæ•´ç¼©ç•¥å›¾ç»„
    function setCurrentIndex(globalIndex, opts = { autoAdjustGroup: true, smoothScroll: false }){
      if (!imagesList || imagesList.length === 0) { currentIndex = -1; renderViewerEmpty(); return; }
      if (globalIndex < 0) globalIndex = 0;
      if (globalIndex > imagesList.length - 1) globalIndex = imagesList.length - 1;
      currentIndex = globalIndex;

      // è®¡ç®—éœ€è¦æ˜¾ç¤ºçš„ç»„èµ·ç‚¹ï¼ˆè‹¥ autoAdjustGroup ä¸º trueï¼‰
      if (opts.autoAdjustGroup) {
        const desiredGroupStart = Math.floor(currentIndex / THUMB_GROUP_SIZE) * THUMB_GROUP_SIZE;
        if (desiredGroupStart !== thumbGroupStart) {
          thumbGroupStart = desiredGroupStart;
          renderThumbGroup();
        } else {
          // same group: only update active highlight
          updateThumbActiveState();
        }
      } else {
        updateThumbActiveState();
      }

      // render main image
      const name = imagesList[currentIndex];
      renderMainImage(name);
      // smoothScroll -> try to scroll the thumbnail container so active thumb is visible (not needed if group changed)
      if (opts.smoothScroll) {
        // find the active thumb element and scroll into view within the strip's visible area
        setTimeout(() => {
          const windowEl = document.getElementById('thumbWindow');
          const active = windowEl.querySelector(`.thumb-item[data-index='${currentIndex}']`);
          if (active) {
            // scroll container (thumbStrip) to make active visible
            const strip = document.getElementById('thumbStrip');
            const stripInner = strip.querySelector('div[style]') || strip.querySelector('div');
            // Use element.scrollIntoView with smooth behavior
            active.scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'});
          }
        }, 60);
      }
    }

    // åˆ‡æ¢åˆ°ä¸Šä¸€ç»„æˆ–ä¸‹ä¸€ç»„ï¼ˆç”¨äºç¼©ç•¥å›¾æ¡è¾¹ç®­å¤´ï¼‰
    function shiftThumbGroup(deltaGroups){
      const newStart = thumbGroupStart + deltaGroups * THUMB_GROUP_SIZE;
      thumbGroupStart = Math.max(0, Math.min(newStart, Math.max(0, imagesList.length - 1)));
      renderThumbGroup();
      // ensure if currentIndex not in new group, adjust it to group's first or keep
      if (currentIndex < thumbGroupStart || currentIndex >= thumbGroupStart + THUMB_GROUP_SIZE) {
        // move currentIndex to the first item in the new group (or keep within bounds)
        const newIndex = Math.min(imagesList.length - 1, thumbGroupStart + 0);
        setCurrentIndex(newIndex, {autoAdjustGroup:false});
      }
    }

    function renderMainImage(name){
      const inner = document.getElementById('viewerInner');
      inner.innerHTML = '';
      scale = 1; translate = {x:0,y:0};
      const img = document.createElement('img');
      img.src = '/uploads/' + encodeURIComponent(name) + '?t=' + Date.now();
      img.alt = name;
      img.draggable = false;
      inner.appendChild(img);
      document.getElementById('viewerOverlay').innerText = name;
      setupImageInteractions(inner, img);
      updateThumbActiveState();
    }

    /* ç¼©æ”¾/æ‹–åŠ¨ */
    function setupImageInteractions(container, imgEl){
      scale = 1; translate = {x:0,y:0}; isPanning = false;
      function applyTransform(){ imgEl.style.transform = `translate(${translate.x}px, ${translate.y}px) scale(${scale})`; }
      imgEl.ondblclick = () => { scale = 1; translate = {x:0,y:0}; applyTransform(); };
      container.onwheel = (ev) => {
        ev.preventDefault();
        const delta = -ev.deltaY;
        const step = delta > 0 ? 0.12 : -0.12;
        const newScale = Math.max(1, Math.min(4, scale + step));
        const rect = imgEl.getBoundingClientRect();
        const cx = ev.clientX - rect.left;
        const cy = ev.clientY - rect.top;
        const relX = (cx - rect.width/2 - translate.x) / scale;
        const relY = (cy - rect.height/2 - translate.y) / scale;
        translate.x -= (newScale - scale) * relX;
        translate.y -= (newScale - scale) * relY;
        scale = newScale;
        applyTransform();
      };
      container.onpointerdown = (ev) => {
        if (scale <= 1) return;
        isPanning = true;
        panStart.x = ev.clientX; panStart.y = ev.clientY;
        container.setPointerCapture(ev.pointerId);
      };
      container.onpointermove = (ev) => {
        if (!isPanning) return;
        const dx = ev.clientX - panStart.x;
        const dy = ev.clientY - panStart.y;
        panStart.x = ev.clientX; panStart.y = ev.clientY;
        translate.x += dx; translate.y += dy;
        applyTransform();
      };
      container.onpointerup = (ev) => {
        if (!isPanning) return;
        isPanning = false;
        try { container.releasePointerCapture(ev.pointerId); } catch(e){}
      };
      container.onpointercancel = () => { isPanning = false; };
    }

    /* prev/next behavior: å½“åˆ°è¾¾ group è¾¹ç•Œæ—¶ä¼šè‡ªåŠ¨è°ƒæ•´ thumbGroupStart */
    function showPrev(){
      if (imagesList.length === 0) return;
      const newIndex = Math.max(0, currentIndex - 1);
      setCurrentIndex(newIndex, {autoAdjustGroup:true, smoothScroll:true});
    }
    function showNext(){
      if (imagesList.length === 0) return;
      const newIndex = Math.min(imagesList.length - 1, currentIndex + 1);
      setCurrentIndex(newIndex, {autoAdjustGroup:true, smoothScroll:true});
    }

    // ä¿®æ”¹æŠ“å›¾æŒ‰é’®äº‹ä»¶
    document.getElementById('grabBtn').addEventListener('click', async () => {
        const firstDeviceElem = document.querySelector('#devicesContainer .device strong');
        if (firstDeviceElem) {
            const dev = firstDeviceElem.innerText;
            // è·å–å½“å‰é€‰ä¸­çš„é€šé“
            const activeChannelBtn = document.querySelector('.channel-btn.active');
            const channel = activeChannelBtn ? activeChannelBtn.dataset.channel : "1";
            
            // æ˜¾ç¤ºå‘é€çŠ¶æ€
            const oldText = document.getElementById('grabBtn').innerText;
            document.getElementById('grabBtn').innerText = 'å‘é€ä¸­...';
            document.getElementById('grabBtn').disabled = true;
            
            try {
                // ä½¿ç”¨æ–°çš„B341 API
                const response = await fetch('/api/send_b341', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        device: dev, 
                        channel: parseInt(channel) 
                    })
                });
                
                const result = await response.json();
                if (result.ok) {
                    showNotification(`å·²å‘è®¾å¤‡ ${dev} å‘é€B341æŠ“å›¾æŒ‡ä»¤`, 'success');
                    // ç­‰å¾…3ç§’åè‡ªåŠ¨åˆ·æ–°å›¾ç‰‡åˆ—è¡¨ï¼ˆç»™è®¾å¤‡æ—¶é—´å¤„ç†æŒ‡ä»¤å¹¶è¿”å›å›¾ç‰‡ï¼‰
                    setTimeout(async () => {
                        await loadImages();
                        showNotification('æ­£åœ¨æ£€æŸ¥æ–°å›¾ç‰‡...', 'info');
                    }, 3000);
                } else {
                    showNotification(`å‘é€å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                showNotification('è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                document.getElementById('grabBtn').innerText = oldText;
                document.getElementById('grabBtn').disabled = false;
            }
        } else {
            showNotification('æ— å¯ç”¨è®¾å¤‡ï¼Œè¯·ç­‰å¾…è®¾å¤‡è¿æ¥', 'error');
        }
    });

    // ä¿®æ”¹è®¾å¤‡åˆ—è¡¨ä¸­çš„"è¦å›¾"æŒ‰é’®é€»è¾‘
    function setupDeviceButtons() {
        const deviceButtons = document.querySelectorAll('#devicesContainer .device button');
        deviceButtons.forEach(btn => {
            btn.onclick = async function() {
                const deviceDiv = this.closest('.device');
                const deviceId = deviceDiv.querySelector('strong').innerText;
                const activeChannelBtn = document.querySelector('.channel-btn.active');
                const channel = activeChannelBtn ? activeChannelBtn.dataset.channel : "1";
                
                const oldText = this.innerText;
                this.innerText = 'å‘é€ä¸­...';
                this.disabled = true;
                
                try {
                    const response = await fetch('/api/send_b341', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            device: deviceId, 
                            channel: parseInt(channel) 
                        })
                    });
                    
                    const result = await response.json();
                    if (result.ok) {
                        showNotification(`å·²å‘è®¾å¤‡ ${deviceId} å‘é€B341æŠ“å›¾æŒ‡ä»¤`, 'success');
                        // ç­‰å¾…ååˆ·æ–°å›¾ç‰‡
                        setTimeout(async () => {
                            await loadImages();
                        }, 3000);
                    } else {
                        showNotification(`å‘é€å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                    }
                } catch (error) {
                    showNotification('è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
                } finally {
                    this.innerText = oldText;
                    this.disabled = false;
                }
            };
        });
    }

    // ä¿®æ”¹loadDeviceså‡½æ•°ï¼Œåœ¨è®¾å¤‡åŠ è½½å®Œæˆåè®¾ç½®æŒ‰é’®
    async function loadDevices() {
      try {
        const data = await fetchJSON('/api/devices');
        const c = document.getElementById('devicesContainer');
        c.innerHTML = '';

        if (!data.devices || data.devices.length === 0) {
          const emptyMsg = document.createElement('div');
          emptyMsg.className = 'device';
          emptyMsg.innerHTML = `
            <div style="text-align:center;width:100%;color:var(--muted)">
              <div>å½“å‰æ— å·²æ³¨å†Œè®¾å¤‡</div>
              <div style="font-size:12px;color:#7ab7b5;margin-top:6px">æ€»è¿æ¥æ•°: ${data.connections||0}</div>
            </div>
          `;
          c.appendChild(emptyMsg);
          return;
        }

        data.devices.forEach(dev => {
          const div = document.createElement('div');
          div.className = 'device';
          div.innerHTML = `
            <div>
              <strong>${dev}</strong>
              <div class="meta">è®¾å¤‡ID: ${dev}</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
              <span style="background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#021212;padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px">å·²æ³¨å†Œ</span>
              <button class="btn small" style="margin-top:6px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#021212;border:none;padding:6px 10px;border-radius:6px;">ğŸ“· è¦å›¾</button>
            </div>
          `;
          c.appendChild(div);
        });

        // è®¾ç½®è®¾å¤‡æŒ‰é’®äº‹ä»¶
        setupDeviceButtons();

      } catch (e) {
        console.error('åŠ è½½è®¾å¤‡å¤±è´¥', e);
        const c = document.getElementById('devicesContainer');
        c.innerHTML = '<div class="device" style="color:#ff6b6b">åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨</div>';
      }
    }

    document.getElementById('prevBtn').addEventListener('click', showPrev);
    document.getElementById('nextBtn').addEventListener('click', showNext);
    window.addEventListener('keydown', (ev) => {
      if (ev.key === 'ArrowLeft') showPrev();
      if (ev.key === 'ArrowRight') showNext();
      if (ev.key === 'Escape') {
        const img = document.querySelector('#viewerInner img');
        if (img) { img.style.transform = 'translate(0px,0px) scale(1)'; scale = 1; translate = {x:0,y:0}; }
      }
    });

    /* strip arrows control groups */
    document.getElementById('stripPrev').addEventListener('click', () => shiftThumbGroup(-1));
    document.getElementById('stripNext').addEventListener('click', () => shiftThumbGroup(1));

    /* ä¸Šä¼  & æ§ä»¶ï¼ˆä¿ç•™æ¥å£ï¼‰ */
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('uploadForm').addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const f = document.getElementById('fileInput').files[0];
        if (!f) { showNotification('è¯·é€‰æ‹©æ–‡ä»¶', 'error'); return; }
        const fd = new FormData();
        fd.append('image', f, f.name);
        const resDiv = document.getElementById('uploadResult');
        resDiv.innerText = 'ä¸Šä¼ ä¸­...';
        try {
          const resp = await fetch('/upload', { method:'POST', body: fd });
          const j = await resp.json();
          if (j.ok) {
            resDiv.innerText = 'ä¸Šä¼ æˆåŠŸ: ' + j.filename;
            showNotification('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success');
            await loadImages();
          } else {
            resDiv.innerText = 'ä¸Šä¼ å¤±è´¥: ' + (j.error||'æœªçŸ¥');
            showNotification('ä¸Šä¼ å¤±è´¥: ' + (j.error||'æœªçŸ¥'), 'error');
          }
        } catch (e) {
          resDiv.innerText = 'ä¸Šä¼ å¼‚å¸¸: ' + e.message;
          showNotification('ä¸Šä¼ å¼‚å¸¸: ' + e.message, 'error');
        }
      });

      document.getElementById('datePicker').addEventListener('change', (ev) => {
        showNotification('å·²é€‰æ‹©æ—¥æœŸ: ' + ev.target.value, 'info');
      });

      // document.getElementById('grabBtn').addEventListener('click', () => {
      //   const firstDeviceElem = document.querySelector('#devicesContainer .device strong');
      //   if (firstDeviceElem) {
      //     const dev = firstDeviceElem.innerText;
      //     fetch('/api/request_snapshot', {
      //       method:'POST', headers:{'Content-Type':'application/json'},
      //       body: JSON.stringify({ device: dev, channel: 1 })
      //     }).then(r=>r.json()).then(j=>{
      //       if (j.ok) showNotification('å·²å‘é€æŠ“å›¾è¯·æ±‚', 'success'); else showNotification('æŠ“å›¾å¤±è´¥', 'error');
      //     }).catch(e=>showNotification('è¯·æ±‚å¤±è´¥: '+e.message,'error'));
      //   } else showNotification('æ— å¯ç”¨è®¾å¤‡', 'error');
      // });

      document.getElementById('playbackBtn').addEventListener('click', () => showNotification('å›æ”¾åŠŸèƒ½ï¼ˆå‰ç«¯å ä½ï¼‰','info'));
      document.getElementById('downloadBtn').addEventListener('click', () => {
        if (currentIndex >= 0 && imagesList[currentIndex]) {
          const url = '/uploads/' + encodeURIComponent(imagesList[currentIndex]);
          const a = document.createElement('a'); a.href = url; a.download = imagesList[currentIndex]; document.body.appendChild(a); a.click(); a.remove();
        } else showNotification('æ— å›¾ç‰‡å¯ä¸‹è½½', 'error');
      });
      document.getElementById('fullBtn').addEventListener('click', () => {
        const viewer = document.getElementById('viewerWrap');
        if (document.fullscreenElement) document.exitFullscreen();
        else viewer.requestFullscreen().catch(()=>showNotification('æ— æ³•è¿›å…¥å…¨å±','error'));
      });

      document.querySelectorAll('.channel-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.channel-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          showNotification('åˆ‡æ¢åˆ°é€šé“ ' + btn.dataset.channel, 'info');
        });
      });

      document.querySelectorAll('.nav-tabs button').forEach(b => {
        b.addEventListener('click', () => {
          document.querySelectorAll('.nav-tabs button').forEach(x => x.classList.remove('active'));
          b.classList.add('active');
          showNotification('åˆ‡æ¢åˆ°ï¼š' + b.innerText, 'info');
        });
      });

      document.getElementById('refreshAll').addEventListener('click', async () => {
        await loadDevices(); await loadImages(); showNotification('å·²åˆ·æ–°', 'success');
      });

      init();
    });

    async function init() {
      try {
        await loadConnectionStats();
        await loadDevices();
        await loadImages();
        refreshInterval = setInterval(async () => { await loadDevices(); await loadConnectionStats(); }, 5000);
      } catch (e) {
        console.error('åˆå§‹åŒ–å¼‚å¸¸', e);
      }
    }
    async function loadConnectionStats(){
      try {
        const data = await fetchJSON('/api/connections');
        document.title = `è®¾å¤‡ç®¡ç† (${data.total_connections||0} è¿æ¥)`;
      } catch(e){}
    }

    function showNotification(message, type='info'){
      const existing = document.getElementById('notification');
      if (existing) existing.remove();
      const n = document.createElement('div');
      n.id = 'notification';
      n.style.position = 'fixed';
      n.style.top = '18px'; n.style.right = '18px';
      n.style.padding = '12px 16px'; n.style.borderRadius = '8px';
      n.style.zIndex = 9999; n.style.boxShadow = '0 8px 30px rgba(0,0,0,0.5)';
      n.style.fontWeight = 700; n.style.color = '#021212';
      if (type === 'success') n.style.background = 'linear-gradient(#06b3b0,#028b86)';
      else if (type === 'error') n.style.background = 'linear-gradient(#ff6b6b,#e74c3c)';
      else n.style.background = 'linear-gradient(#a8eae6,#7ab7b5)';
      n.innerText = message;
      document.body.appendChild(n);
      setTimeout(() => { n.style.opacity = '0'; n.style.transform = 'translateX(60px)'; setTimeout(()=>n.remove(),300); }, 2500);
    }

    window.addEventListener('beforeunload', () => { if (refreshInterval) clearInterval(refreshInterval); });
  </script>
</body>
</html>

<!-- è®¾å¤‡æ™ºèƒ½åŠ©æ‰‹æµ®çª— -->
<script src="./agent_widget.js"></script>