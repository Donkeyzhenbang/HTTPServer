<!-- index.html
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>è¦å›¾ç¤ºä¾‹ - æ‘„åƒå¤´å±•ç¤º</title>
  <style>
    body { background:#061d22; color:#c7f7f7; font-family: Arial, sans-serif; margin:0; padding:20px; }
    .top { display:flex; gap:20px; align-items:center; }
    .upload-box { background:#07363b; padding:12px; border-radius:8px; }
    input[type=file] { color:#fff; }
    .gallery { margin-top:20px; display:flex; gap:12px; flex-wrap:wrap; }
    .thumb { width:160px; height:90px; overflow:hidden; border-radius:6px; background:#000; display:flex; align-items:center; justify-content:center; cursor:pointer; border:2px solid rgba(0,255,220,0.08); }
    .thumb img { max-width:100%; max-height:100%; }
    .viewer { margin-top:20px; border:2px solid #0f8b8f; padding:6px; border-radius:6px; width:900px; height:500px; background:#021212; display:flex; align-items:center; justify-content:center; }
    .device-list { margin-left:40px; min-width:240px; background:#022b2f; padding:12px; border-radius:8px; }
    .device { padding:8px; border-bottom:1px dashed #024; display:flex; justify-content:space-between; align-items:center; }
    .btn { background:linear-gradient(#06b3b0,#028b86); color:#021212; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
    .small { padding:4px 8px; font-size:0.9em; }
    .muted { color:#a8eae6; font-size:0.9em; }
  </style>
</head>
<body>
  <h1>æ‘„åƒå¤´è¦å›¾æ¼”ç¤º</h1>
  <div class="top">
    <div class="upload-box">
      <form id="uploadForm">
        <input id="fileInput" type="file" name="image" accept="image/*" />
        <button type="submit" class="btn small">ä¸Šä¼ å›¾ç‰‡</button>
      </form>
      <div id="uploadResult" class="muted"></div>
    </div>

    <div class="device-list" id="deviceList">
      <h3>å·²æ³¨å†Œè®¾å¤‡</h3>
      <div id="devicesContainer"><div class="muted">æ­£åœ¨åŠ è½½...</div></div>
    </div>
  </div>

  <div id="viewer" class="viewer">å¤§å›¾é¢„è§ˆåŒºåŸŸï¼ˆç‚¹å‡»ç¼©ç•¥å›¾ï¼‰</div>

  <h3>å›¾ç‰‡åº“</h3>
  <div id="gallery" class="gallery"></div>

<script>
async function fetchJSON(url, opts){ const r = await fetch(url, opts); return r.json(); }

async function loadDevices(){
  try{
    const arr = await fetch('/api/devices').then(r=>r.json());
    const c = document.getElementById('devicesContainer');
    c.innerHTML = '';
    if (!arr || arr.length===0) { c.innerHTML = '<div class="muted">å½“å‰æ— è®¾å¤‡è¿æ¥</div>'; return; }
    arr.forEach(dev=>{
      const div = document.createElement('div'); div.className='device';
      const left = document.createElement('div'); left.innerHTML = `<strong>${dev}</strong>`;
      const right = document.createElement('div');
      const btn1 = document.createElement('button'); btn1.className='btn small'; btn1.innerText='è¦å›¾(é€šé“1)';
      btn1.onclick = async () => {
        btn1.disabled = true;
        try {
          const resp = await fetch('/api/request_snapshot', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({device: dev, channel:1})
          });
          const j = await resp.json();
          if (j.ok) alert('å·²ä¸‹å‘è¦å›¾æŒ‡ä»¤');
          else alert('å‘é€å¤±è´¥: ' + (j.error||'unknown'));
        } catch(e){ alert('è¯·æ±‚å¤±è´¥: '+e); }
        btn1.disabled = false;
      };
      right.appendChild(btn1);
      div.appendChild(left);
      div.appendChild(right);
      c.appendChild(div);
    });
  } catch(e) {
    console.error(e);
  }
}

async function loadImages(){
  try{
    const arr = await fetch('/api/images').then(r=>r.json());
    const g = document.getElementById('gallery');
    g.innerHTML = '';
    if (!arr || arr.length===0) { g.innerHTML = '<div class="muted">æš‚æ— å›¾ç‰‡</div>'; return; }
    arr.forEach(name=>{
      const th = document.createElement('div'); th.className='thumb';
      const img = document.createElement('img');
      // img.src = '/uploads?name=' + encodeURIComponent(name);
      img.src = '/uploads/' + encodeURIComponent(name) + '?t=' + Date.now();
      img.alt = name;
      th.appendChild(img);
      th.onclick = () => {
        const viewer = document.getElementById('viewer');
        viewer.innerHTML = '';
        const big = document.createElement('img');
        // big.src = img.src;
        big.src = '/uploads/' + encodeURIComponent(name) + '?t=' + Date.now();
        big.style.maxWidth = '100%';
        big.style.maxHeight = '100%';
        viewer.appendChild(big);
      };
      // å°æ ‡é¢˜
      const caption = document.createElement('div'); caption.className='muted'; caption.style.fontSize='0.8em'; caption.style.marginTop='6px';
      caption.innerText = name;
      const wrapper = document.createElement('div');
      wrapper.appendChild(th);
      wrapper.appendChild(caption);
      g.appendChild(wrapper);
    });
  } catch(e) { console.error(e); }
}

document.getElementById('uploadForm').addEventListener('submit', async (ev) => {
  ev.preventDefault();
  const f = document.getElementById('fileInput').files[0];
  if (!f) { alert('è¯·é€‰æ‹©æ–‡ä»¶'); return; }
  const fd = new FormData();
  fd.append('image', f, f.name);
  const resDiv = document.getElementById('uploadResult');
  resDiv.innerText = 'ä¸Šä¼ ä¸­...';
  try {
    const resp = await fetch('/upload', { method:'POST', body: fd });
    const j = await resp.json();
    if (j.ok) {
      resDiv.innerText = 'ä¸Šä¼ æˆåŠŸ: ' + j.filename;
      await loadImages();
    } else {
      resDiv.innerText = 'ä¸Šä¼ å¤±è´¥';
    }
  } catch (e) {
    resDiv.innerText = 'ä¸Šä¼ å¼‚å¸¸: ' + e;
  }
});

// åˆå§‹åŒ–
loadDevices();
loadImages();
// æ¯ 3 ç§’åˆ·æ–°è®¾å¤‡åˆ—è¡¨
setInterval(loadDevices, 3000);
</script>
</body>
</html> -->

<!-- web/index.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>è®¾å¤‡ç®¡ç†ä¸æ‘„åƒå¤´å±•ç¤º</title>
  <style>
    body { background:#061d22; color:#c7f7f7; font-family: Arial, sans-serif; margin:0; padding:20px; }
    .top { display:flex; gap:20px; align-items:flex-start; margin-bottom: 30px; }
    .upload-box { background:#07363b; padding:15px; border-radius:8px; min-width: 300px; }
    input[type=file] { color:#fff; margin-bottom: 10px; }
    .gallery { margin-top:20px; display:flex; gap:12px; flex-wrap:wrap; }
    .thumb { width:160px; height:90px; overflow:hidden; border-radius:6px; background:#000; display:flex; align-items:center; justify-content:center; cursor:pointer; border:2px solid rgba(0,255,220,0.08); }
    .thumb img { max-width:100%; max-height:100%; }
    .viewer { margin-top:20px; border:2px solid #0f8b8f; padding:6px; border-radius:6px; width:900px; height:500px; background:#021212; display:flex; align-items:center; justify-content:center; }
    .device-panel { min-width:320px; background:#022b2f; padding:15px; border-radius:8px; border: 1px solid #024; }
    .device-panel h3 { margin-top: 0; color: #06b3b0; border-bottom: 1px solid #024; padding-bottom: 10px; }
    .device { padding:12px; border-bottom:1px dashed #024; display:flex; justify-content:space-between; align-items:center; transition: background 0.3s; }
    .device:hover { background: rgba(6, 179, 176, 0.1); }
    .btn { background:linear-gradient(#06b3b0,#028b86); color:#021212; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; font-weight: bold; transition: all 0.3s; }
    .btn:hover { background:linear-gradient(#07d4d0,#06b3b0); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    .btn:disabled { background:#555; color:#888; cursor: not-allowed; transform: none; box-shadow: none; }
    .small { padding:6px 10px; font-size:0.9em; }
    .muted { color:#a8eae6; font-size:0.9em; }
    .status-badge { background:#028b86; color:#021212; padding:2px 8px; border-radius:12px; font-size:0.8em; font-weight: bold; margin-left: 8px; }
    .status-badge.unregistered { background:#555; color:#ddd; }
    .refresh-btn { background: #024; color: #a8eae6; border: 1px solid #06b3b0; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-left: 10px; }
    .refresh-btn:hover { background: #06b3b0; color: #021212; }
    .stats-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  </style>
</head>
<body>
  <h1>è®¾å¤‡ç®¡ç†ä¸æ‘„åƒå¤´å±•ç¤º</h1>
  
  <div class="top">
    <!-- å·¦ä¾§ï¼šå›¾ç‰‡ä¸Šä¼  -->
    <div class="upload-box">
      <h3>å›¾ç‰‡ä¸Šä¼ </h3>
      <form id="uploadForm">
        <input id="fileInput" type="file" name="image" accept="image/*" />
        <button type="submit" class="btn small">ä¸Šä¼ å›¾ç‰‡</button>
      </form>
      <div id="uploadResult" class="muted"></div>
    </div>
    
    <!-- å³ä¾§ï¼šè®¾å¤‡ç®¡ç† -->
    <div class="device-panel" id="deviceList">
      <div class="stats-header">
        <h3>è®¾å¤‡ç®¡ç†</h3>
        <div>
          <button id="refreshDevices" class="refresh-btn">åˆ·æ–°</button>
          <button id="testAddConnection" class="refresh-btn" title="æ·»åŠ æµ‹è¯•è¿æ¥">+ æµ‹è¯•</button>
        </div>
      </div>
      <div id="devicesContainer">
        <div class="muted">æ­£åœ¨åŠ è½½è®¾å¤‡åˆ—è¡¨...</div>
      </div>
    </div>
  </div>

  <div id="viewer" class="viewer">
    <div style="color: #a8eae6; font-size: 1.1em;">å¤§å›¾é¢„è§ˆåŒºåŸŸï¼ˆç‚¹å‡»ä¸‹æ–¹ç¼©ç•¥å›¾ï¼‰</div>
  </div>

  <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0;">
    <h3>å›¾ç‰‡åº“</h3>
    <button id="refreshImages" class="refresh-btn">åˆ·æ–°å›¾ç‰‡</button>
  </div>
  <div id="gallery" class="gallery"></div>

<script>
// å…¨å±€å˜é‡
let refreshInterval;

// è·å–JSONæ•°æ®
async function fetchJSON(url, opts = {}) { 
    const r = await fetch(url, opts); 
    return r.json(); 
}

// åŠ è½½è¿æ¥ç»Ÿè®¡ä¿¡æ¯
async function loadConnectionStats() {
    try {
        const data = await fetchJSON('/api/connections');
        
        // æ›´æ–°é¡µé¢æ ‡é¢˜æ˜¾ç¤ºè¿æ¥æ•°
        document.title = `è®¾å¤‡ç®¡ç† (${data.total_connections} è¿æ¥)`;
        
        // å¯ä»¥åœ¨è¿™é‡Œæ›´æ–°å…¨å±€çš„è¿æ¥ç»Ÿè®¡æ˜¾ç¤º
        console.log('è¿æ¥ç»Ÿè®¡:', data);
    } catch(e) {
        console.error('åŠ è½½è¿æ¥ç»Ÿè®¡å¤±è´¥:', e);
    }
}

// åŠ è½½è®¾å¤‡åˆ—è¡¨
async function loadDevices() {
    try {
        const data = await fetchJSON('/api/devices');
        const c = document.getElementById('devicesContainer');
        c.innerHTML = '';
        
        if (!data.devices || data.devices.length === 0) {
            const emptyMsg = document.createElement('div');
            emptyMsg.className = 'device';
            emptyMsg.innerHTML = `
                <div style="text-align: center; width: 100%;">
                    <div class="muted">å½“å‰æ— å·²æ³¨å†Œè®¾å¤‡</div>
                    <div style="font-size: 0.8em; color: #7ab7b5; margin-top: 5px;">
                        æ€»è¿æ¥æ•°: ${data.connections}
                    </div>
                </div>
            `;
            c.appendChild(emptyMsg);
            return;
        }
        
        // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
        const statsDiv = document.createElement('div');
        statsDiv.className = 'device';
        statsDiv.style.background = 'rgba(2, 52, 58, 0.5)';
        statsDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between; width: 100%;">
                <div>
                    <strong>å·²æ³¨å†Œè®¾å¤‡:</strong> <span style="color: #06b3b0;">${data.devices.length}</span>
                </div>
                <div>
                    <strong>æ€»è¿æ¥æ•°:</strong> <span style="color: #06b3b0;">${data.connections}</span>
                </div>
            </div>
        `;
        c.appendChild(statsDiv);
        
        // æ˜¾ç¤ºæ¯ä¸ªè®¾å¤‡
        data.devices.forEach(dev => {
            const div = document.createElement('div');
            div.className = 'device';
            
            const left = document.createElement('div');
            left.innerHTML = `
                <div style="display: flex; align-items: center;">
                    <strong>${dev}</strong>
                    <span class="status-badge">å·²æ³¨å†Œ</span>
                </div>
                <div style="font-size: 0.8em; color: #7ab7b5; margin-top: 4px;">
                    è®¾å¤‡ID: ${dev}
                </div>
            `;
            
            const right = document.createElement('div');
            const btn1 = document.createElement('button');
            btn1.className = 'btn small';
            btn1.innerHTML = '<span style="font-size: 0.9em;">ğŸ“· è¦å›¾</span>';
            btn1.title = 'è¯·æ±‚é€šé“1çš„å¿«ç…§';
            
            btn1.onclick = async () => {
                btn1.disabled = true;
                btn1.innerHTML = '<span style="font-size: 0.9em;">â³ å‘é€ä¸­...</span>';
                
                try {
                    const resp = await fetch('/api/request_snapshot', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ device: dev, channel: 1 })
                    });
                    
                    const j = await resp.json();
                    if (j.ok) {
                        showNotification(`å·²å‘è®¾å¤‡ ${dev} å‘é€è¦å›¾æŒ‡ä»¤`, 'success');
                    } else {
                        showNotification(`å‘é€å¤±è´¥: ${j.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                    }
                } catch(e) {
                    showNotification(`è¯·æ±‚å¤±è´¥: ${e.message}`, 'error');
                    console.error(e);
                } finally {
                    btn1.disabled = false;
                    btn1.innerHTML = '<span style="font-size: 0.9em;">ğŸ“· è¦å›¾</span>';
                }
            };
            
            right.appendChild(btn1);
            div.appendChild(left);
            div.appendChild(right);
            c.appendChild(div);
        });
        
    } catch(e) {
        console.error('åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥:', e);
        const c = document.getElementById('devicesContainer');
        c.innerHTML = '<div class="muted" style="color: #ff6b6b;">åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨è¿æ¥</div>';
    }
}

// åŠ è½½å›¾ç‰‡
async function loadImages() {
    try {
        const arr = await fetchJSON('/api/images');
        const g = document.getElementById('gallery');
        g.innerHTML = '';
        
        if (!arr || arr.length === 0) {
            g.innerHTML = '<div class="muted" style="width: 100%; text-align: center; padding: 40px;">æš‚æ— å›¾ç‰‡ï¼Œè¯·ä¸Šä¼ å›¾ç‰‡</div>';
            return;
        }
        
        arr.forEach(name => {
            const wrapper = document.createElement('div');
            wrapper.style.width = '172px';
            wrapper.style.marginBottom = '15px';
            
            const th = document.createElement('div');
            th.className = 'thumb';
            
            const img = document.createElement('img');
            img.src = '/uploads/' + encodeURIComponent(name) + '?t=' + Date.now();
            img.alt = name;
            img.loading = 'lazy';
            
            th.appendChild(img);
            
            // ç‚¹å‡»é¢„è§ˆå¤§å›¾
            th.onclick = () => {
                const viewer = document.getElementById('viewer');
                viewer.innerHTML = '';
                const big = document.createElement('img');
                big.src = '/uploads/' + encodeURIComponent(name) + '?t=' + Date.now();
                big.style.maxWidth = '100%';
                big.style.maxHeight = '100%';
                big.style.borderRadius = '4px';
                viewer.appendChild(big);
            };
            
            // å›¾ç‰‡ä¿¡æ¯
            const caption = document.createElement('div');
            caption.className = 'muted';
            caption.style.fontSize = '0.8em';
            caption.style.marginTop = '6px';
            caption.style.overflow = 'hidden';
            caption.style.textOverflow = 'ellipsis';
            caption.style.whiteSpace = 'nowrap';
            caption.innerText = name;
            
            wrapper.appendChild(th);
            wrapper.appendChild(caption);
            g.appendChild(wrapper);
        });
    } catch(e) {
        console.error('åŠ è½½å›¾ç‰‡å¤±è´¥:', e);
        const g = document.getElementById('gallery');
        g.innerHTML = '<div class="muted" style="color: #ff6b6b;">åŠ è½½å›¾ç‰‡å¤±è´¥</div>';
    }
}

// æ˜¾ç¤ºé€šçŸ¥
function showNotification(message, type = 'info') {
    // ç§»é™¤ç°æœ‰çš„é€šçŸ¥
    const existing = document.getElementById('notification');
    if (existing) existing.remove();
    
    const notification = document.createElement('div');
    notification.id = 'notification';
    notification.style.position = 'fixed';
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.padding = '15px 20px';
    notification.style.borderRadius = '6px';
    notification.style.color = '#021212';
    notification.style.fontWeight = 'bold';
    notification.style.zIndex = '1000';
    notification.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
    notification.style.transition = 'all 0.3s';
    
    if (type === 'success') {
        notification.style.background = 'linear-gradient(#06b3b0, #028b86)';
    } else if (type === 'error') {
        notification.style.background = 'linear-gradient(#ff6b6b, #e74c3c)';
    } else {
        notification.style.background = 'linear-gradient(#a8eae6, #7ab7b5)';
    }
    
    notification.innerText = message;
    document.body.appendChild(notification);
    
    // 3ç§’åè‡ªåŠ¨ç§»é™¤
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100px)';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// åˆå§‹åŒ–é¡µé¢
async function init() {
    try {
        // åŠ è½½è¿æ¥ç»Ÿè®¡
        await loadConnectionStats();
        
        // åŠ è½½è®¾å¤‡åˆ—è¡¨
        await loadDevices();
        
        // åŠ è½½å›¾ç‰‡
        await loadImages();
        
        showNotification('é¡µé¢åŠ è½½å®Œæˆ', 'success');
    } catch(e) {
        console.error('åˆå§‹åŒ–å¤±è´¥:', e);
        showNotification('é¡µé¢åˆå§‹åŒ–å¤±è´¥: ' + e.message, 'error');
    }
}

// äº‹ä»¶ç›‘å¬å™¨
document.addEventListener('DOMContentLoaded', () => {
    // ä¸Šä¼ è¡¨å•
    document.getElementById('uploadForm').addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const f = document.getElementById('fileInput').files[0];
        if (!f) { 
            showNotification('è¯·é€‰æ‹©æ–‡ä»¶', 'error');
            return; 
        }
        
        const fd = new FormData();
        fd.append('image', f, f.name);
        const resDiv = document.getElementById('uploadResult');
        resDiv.innerText = 'ä¸Šä¼ ä¸­...';
        resDiv.style.color = '#a8eae6';
        
        try {
            const resp = await fetch('/upload', { method: 'POST', body: fd });
            const j = await resp.json();
            if (j.ok) {
                resDiv.innerText = 'ä¸Šä¼ æˆåŠŸ: ' + j.filename;
                resDiv.style.color = '#06b3b0';
                showNotification('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success');
                await loadImages();
            } else {
                resDiv.innerText = 'ä¸Šä¼ å¤±è´¥: ' + (j.error || 'æœªçŸ¥é”™è¯¯');
                resDiv.style.color = '#ff6b6b';
                showNotification('ä¸Šä¼ å¤±è´¥: ' + (j.error || 'æœªçŸ¥é”™è¯¯'), 'error');
            }
        } catch (e) {
            resDiv.innerText = 'ä¸Šä¼ å¼‚å¸¸: ' + e.message;
            resDiv.style.color = '#ff6b6b';
            showNotification('ä¸Šä¼ å¼‚å¸¸: ' + e.message, 'error');
        }
    });
    
    // åˆ·æ–°è®¾å¤‡æŒ‰é’®
    document.getElementById('refreshDevices').addEventListener('click', async () => {
        const btn = document.getElementById('refreshDevices');
        btn.disabled = true;
        btn.innerHTML = 'åˆ·æ–°ä¸­...';
        
        await loadDevices();
        await loadConnectionStats();
        
        btn.disabled = false;
        btn.innerHTML = 'åˆ·æ–°';
        showNotification('è®¾å¤‡åˆ—è¡¨å·²åˆ·æ–°', 'success');
    });
    
    // åˆ·æ–°å›¾ç‰‡æŒ‰é’®
    document.getElementById('refreshImages').addEventListener('click', async () => {
        const btn = document.getElementById('refreshImages');
        btn.disabled = true;
        btn.innerHTML = 'åˆ·æ–°ä¸­...';
        
        await loadImages();
        
        btn.disabled = false;
        btn.innerHTML = 'åˆ·æ–°å›¾ç‰‡';
        showNotification('å›¾ç‰‡åº“å·²åˆ·æ–°', 'success');
    });
    
    // æµ‹è¯•æ·»åŠ è¿æ¥æŒ‰é’®
    document.getElementById('testAddConnection').addEventListener('click', async () => {
        const btn = document.getElementById('testAddConnection');
        btn.disabled = true;
        btn.innerHTML = 'æ·»åŠ ä¸­...';
        
        try {
            const data = await fetchJSON('/api/test/add_connection');
            showNotification(`æ·»åŠ æµ‹è¯•è¿æ¥æˆåŠŸ (fd: ${data.fd})`, 'success');
            
            // åˆ·æ–°è®¾å¤‡åˆ—è¡¨
            await loadDevices();
            await loadConnectionStats();
        } catch(e) {
            showNotification('æ·»åŠ æµ‹è¯•è¿æ¥å¤±è´¥: ' + e.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '+ æµ‹è¯•';
        }
    });
    
    // è®¾ç½®å®šæ—¶åˆ·æ–°ï¼ˆæ¯5ç§’ï¼‰
    refreshInterval = setInterval(async () => {
        await loadDevices();
        await loadConnectionStats();
    }, 5000);
    
    // åˆå§‹åŒ–é¡µé¢
    init();
});

// é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
window.addEventListener('beforeunload', () => {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});
</script>
</body>
</html>